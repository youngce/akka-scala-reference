# 工作原理

集群中的每个节点都会启动 `ShardRegion` Actor，或者被被标记为特定角色(role)的一组节点。`ShardRegion`由两个应用指定的函数创建，分别用于为传入的消息解析实体标识符和分片标识符。一个分片是一组被一起管理的实体。对于特定分片的第一条消息，`ShardRegion`会从中心协调器 `ShardCoordinator` 来请求其位置。

`ShardCoordinator`会决定哪个`ShardRegion`拥有对应分片并通知该`ShardRegion`。`ShardRegion`会确认请求并以子 Actor 的方式创建一个`Shard`管理员。当`Shard` Actor 需要的时候，单个的`Entities`则会被创建。传入的消息则会通过`ShardRegion`和`Shard`传递到目标`Entity`。

如果分片的位置属于另一个`ShardRegion`实例，消息则会被转发到该实例。在查找分片位置期间，传入到分片的消息会被缓存并在找到分片位置之后被送达。随后发送到这个分片的消息则直接能够抵达目标而无需再涉及到`ShardCoordinator`。

场景一：

1. 传入的消息 M1 到`ShardRegion`实例 R1
2. M1 被映射到分片 S1，R1 并不知道 S1，因此向协调器 C 请求 S1 的位置
3. C 回答了 S1 的位置在 R1
4. R1 为实体 E1 创建子 Actor 并向其发送被缓存的从 S1 到 E1 的消息
5. 所有从 S1 到达 R1的消息这时可以直接由 R1 来处理而不再经过 C。R1 会按需创建实体的子 Actor，并向它们转发消息


场景二：

1. 传入消息 M2 到 R1
2. M2 被映射到 S2，R1 并不知道 S2，因此向协调器 C 请求 S2 的位置
3. C 回答了 S2 的位置是 R2
4. R1 将那些要发送给 S2 并已被缓存的消息发送给 R2
5. 所有要发送给 S2 的并到达 R1 的消息将会通过 R1 处理，不再经过 C。R1 将消息发送给 R2
6. R2 接收到了要发送给 S2 的消息，请求 C，得到 S2 的位置在 R2，这时就回到了第一个场景

要确保一个特定的实体 Actor 在集群中最多只能有一个实例运行在集群的某个位置，这很重要，因为分片所处的集群中所有的节点要拥有相同的视图(view)。因此分片的分配决定由中心`ShardCoordinator`来完成，它作为一个集群单例运行，比如，运行在集群中所有节点或由角色名标记的一组节点中的最老节点上的实例。

